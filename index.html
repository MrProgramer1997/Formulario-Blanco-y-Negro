<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reserva – Fiesta Blanco & Negro</title>
  <meta name="description" content="Formulario de reservas – GitHub Pages + Supabase" />
  <style>
    :root{--bg:#0b0b0d;--card:#141418;--muted:#a4a6ad;--text:#f1f1f3;--ok:#1aa34a;--warn:#f6c445;--err:#ff5a5a}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;line-height:1.45}
    .wrap{max-width:980px;margin:auto;padding:20px}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b0b0dd0,#0b0b0d00);backdrop-filter:saturate(150%) blur(2px);z-index:5}
    .title{display:flex;align-items:center;gap:16px}
    .title h1{font-size:clamp(22px,3.2vw,34px);margin:0}
    .card{background:var(--card);border:1px solid #22242a;border-radius:16px;padding:20px;box-shadow:0 10px 30px #00000040}
    .grid{display:grid;gap:16px}
    @media (min-width:860px){.grid-2{grid-template-columns:1fr 1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2c2f36;background:#0f1013;color:var(--text);outline:none}
    input:focus,select:focus{border-color:#5c6cff;box-shadow:0 0 0 3px #5c6cff30}
    small.hint{color:var(--muted);font-size:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid #2c2f36;background:#101217;color:var(--text);padding:12px 16px;border-radius:12px;cursor:pointer;text-decoration:none;font-weight:600}
    .btn:hover{background:#151826}
    .btn.primary{background:#5c6cff;border-color:#5c6cff;color:#fff}
    .btn.ghost{background:#0f1013}
    .danger{color:var(--err)}
    .ok{color:var(--ok)}
    .kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .kpi div{background:#0f1013;border:1px dashed #2c2f36;border-radius:12px;padding:12px;text-align:center}
    figure{margin:0;border-radius:16px;overflow:hidden;border:1px solid #22242a}
    figcaption{padding:8px 10px;color:var(--muted);font-size:12px;background:#0f1013}
    .bank{display:grid;gap:10px}
    .bank .item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:12px;border-radius:12px;background:#0f1013;border:1px solid #2c2f36}
    .alert{border-left:4px solid var(--warn);background:#17130a;border-radius:12px;padding:12px 14px}
    .terms{display:flex;gap:8px;align-items:center}  /* checkbox pegado al texto */
    .pill{display:inline-block;padding:6px 10px;border:1px solid #2c2f36;border-radius:999px;background:#0f1013;color:#a4a6ad;font-size:12px}
    .list{margin:0;padding-left:18px}
    .muted{color:#a4a6ad}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .b-ok{background:#0d2;color:#000}
    .b-warn{background:#fb0;color:#000}
    .b-err{background:#f55;color:#fff}
    .b-block{background:#888;color:#000}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="wrap">
    <div class="title">
      <img src="./assets/plano-blanco-negro.jpg" alt="Plano de ubicación de mesas" style="width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid #2c2f36"/>
      <div>
        <h1>Reserva de mesas · Fiesta Blanco & Negro</h1>
        <div class="row"><span class="pill">Sábado 22 de noviembre</span><span class="pill">Salón Rialto & Lobby</span><span class="pill">Horario: 7:00 p.m. – 5:00 a.m.</span></div>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:14px">
    <!-- MAPA -->
    <section class="card grid">
      <figure>
        <img src="./assets/plano-blanco-negro.jpg" alt="Plano de mesas (referencia)" style="width:100%;display:block"/>
        <figcaption>Revise la disponibilidad y ubicación de las mesas antes de reservar. La ubicación está sujeta a cambios por montaje.</figcaption>
      </figure>
      <div class="kpi">
        <div><strong>Capacidad por mesa</strong><br><span>10 personas</span></div>
        <div><strong>Mínimo para reservar</strong><br><span class="ok">8 personas</span></div>
        <div><strong>Edad mínima</strong><br><span>18 años</span></div>
      </div>
    </section>

    <!-- LISTA COMPLETA DE MESAS (ocupadas, disponibles, bloqueada) -->
    <section class="card">
      <h3 style="margin:0">Estado de mesas</h3>
      <p class="hint">Ves cuáles están disponibles, cuántos cupos quedan y cuáles están ocupadas. <span class="danger">La mesa 2 está bloqueada.</span></p>
      <ul id="lista-mesas" class="list"></ul>
    </section>

    <!-- ALERTA PENALIDAD -->
    <section class="card alert">
      <strong>Importante:</strong> En el caso de reservar y no asistir, el club facturará dentro de la cuota de sostenimiento, un valor de <strong>$200.000</strong> por persona.
    </section>

    <!-- FORMULARIO -->
    <section class="card">
      <h2 style="margin-top:0">Formulario de reserva</h2>
      <form id="form-reserva">
        <div class="grid grid-2">
          <div>
            <label for="nombres">Nombre del responsable</label>
            <input id="nombres" name="nombres" required placeholder="Nombre y apellido" />
          </div>
          <div>
            <label for="contacto">Teléfono / WhatsApp</label>
            <input id="contacto" name="contacto" inputmode="tel" placeholder="312 759 6112" required />
          </div>
          <div>
            <label for="correo">Correo electrónico</label>
            <input id="correo" type="email" name="correo" placeholder="correo@ejemplo.com" required />
          </div>
          <div>
            <label for="accion_responsable">N.º de acción del socio responsable</label>
            <input id="accion_responsable" name="accion_responsable" placeholder="Acción o cupo" />
          </div>
          <div>
            <label for="mesa">Mesa</label>
            <select id="mesa" name="mesa" required>
              <option value="" selected disabled>Cargando mesas…</option>
            </select>
            <small class="hint">Solo se muestran mesas con cupos. La mesa 2 no aparece por estar bloqueada.</small>
          </div>
          <div>
            <label for="cantidad">Cantidad de puestos a reservar</label>
            <select id="cantidad" name="cantidad" required>
              <option value="" selected disabled>Selecciona (mínimo 8)</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
            </select>
            <small class="hint">Cada mesa tiene máximo 10 puestos.</small>
          </div>
        </div>

        <!-- RESPONSABLE ASISTE -->
        <div class="row" style="margin-top:2px">
          <label class="terms">
            <input type="checkbox" id="responsable_asiste" checked />
            <span>¿El responsable también asiste al evento? <strong>Sí</strong> (se descuenta 1 cupo y se registra como <strong>socio</strong>)</span>
          </label>
          <small class="hint" id="nota-resp">* De los cupos seleccionados, se descuenta el del responsable.</small>
        </div>

        <!-- DISTRIBUCIÓN DE CUPOS -->
        <div class="card" style="background:#0f1013;border:1px dashed #2c2f36">
          <label style="font-weight:700">Distribuye los cupos</label>
          <div class="grid grid-2" style="margin-top:8px">
            <div>
              <label for="cupos_socios">Cupos para <strong>Socios</strong> (además del responsable)</label>
              <input id="cupos_socios" type="number" min="0" value="0" />
            </div>
            <div>
              <label for="cupos_invitados">Cupos para <strong>Invitados</strong></label>
              <input id="cupos_invitados" type="number" min="0" value="0" />
            </div>
            <div>
              <small class="hint" id="suma-cupos">Seleccionados 0 + 1 (responsable) = 1 de 8 cupos</small>
            </div>
          </div>
        </div>

        <!-- FORMULARIOS SEGÚN TIPO -->
        <div class="grid" id="bloques-datos" style="margin-top:8px">
          <div class="grid" id="datos-socios"></div>
          <div class="grid" id="datos-invitados"></div>
        </div>

        <hr style="border:0;border-top:1px solid #2c2f36;margin:18px 0"/>

        <!-- COSTO Y BANCOS -->
        <div class="grid grid-2">
          <div>
            <label>Total a pagar por Invitados</label>
            <div class="card" style="padding:12px;background:#0f1013;border:1px solid #2c2f36">
              <div id="resumen-pago" class="row">0 invitados × $250.000 = <strong>$0</strong></div>
              <small class="hint">Socios: $0 según protocolo.</small>
            </div>
          </div>
          <div>
            <label>Transferencia bancaria</label>
            <small class="hint">Realiza la transferencia y comparte el soporte por WhatsApp o en la oficina de eventos.</small>
            <div class="bank" style="margin-top:8px">
              <div class="item"><span>Davivienda • CC <strong>126669999149</strong></span><button class="btn" type="button" data-copy="126669999149">Copiar</button></div>
              <div class="item"><span>Bancolombia • CC <strong>07322164601</strong></span><button class="btn" type="button" data-copy="07322164601">Copiar</button></div>
              <div class="row"><a class="btn ghost" href="https://www.davivienda.com/" target="_blank" rel="noopener">Ir a Davivienda</a><a class="btn ghost" href="https://www.bancolombia.com/" target="_blank" rel="noopener">Ir a Bancolombia</a></div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <label class="terms">
            <input id="acepto" type="checkbox" required />
            <span>Confirmo que reservo mínimo 8 puestos y acepto que, en caso de no asistir, se cobrará $200.000 por persona en mi cuota de sostenimiento.</span>
          </label>
        </div>

        <div class="row" style="margin-top:12px">
          <label class="hint" style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="demo" /> Modo prueba (no descuenta cupos ni guarda en la base de datos)
          </label>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" type="submit" id="btn-enviar">Reservar mesa</button>
          <a class="btn ghost" target="_blank" rel="noopener" id="btn-whatsapp" href="https://wa.me/573127596112">Hablar por WhatsApp</a>
        </div>

        <p id="estado" class="hint" style="margin-top:10px"></p>
      </form>
    </section>

    <!-- PROTOCOLO -->
    <section class="card grid">
      <h3 style="margin:0">Protocolo y condiciones</h3>
      <ul>
        <li>Código de vestimenta: elegante blanco/negro (mujeres: vestido largo o conjunto; hombres: pantalón, camisa y chaqueta sin corbata).</li>
        <li>Edad mínima: 18 años.</li>
        <li>Horario: 7:00 p.m. a 5:00 a.m.</li>
        <li>Valor por persona: corporado $0; invitado $250.000.</li>
        <li>Acomodación: mesas rectangulares de 8 (máx. 10) en Salón Rialto y Lobby. Para grupos de 2–7, escribir a WhatsApp 3127596112.</li>
        <li>Reservas/cancelaciones hasta jueves 20 de noviembre o hasta agotar disponibilidad.</li>
        <li>Pasos: (1) revise y elija mesa; (2) complete este formulario; (3) pague invitados y registre en oficina de eventos.</li>
        <li>En caso de no cumplir con el mínimo de puestos, el club podrá reubicar su grupo.</li>
        <li>La ubicación de mesas puede cambiar según necesidades de montaje.</li>
      </ul>
    </section>
  </main>

  <footer>© Club Campestre Pereira – Fiesta Blanco & Negro</footer>

  <script>
    // ====== CONFIGURACIÓN SUPABASE ======
    const SUPABASE_URL = "https://cmrydhzpcuklfvigboka.supabase.co"; // <-- reemplaza
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtcnlkaHpwY3VrbGZ2aWdib2thIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzU1NDIsImV4cCI6MjA3ODExMTU0Mn0.SzLh-CoahU63AISJwPKJLJkAf-JQ2qxAwUt69NsPKgQ";                // <-- reemplaza
    const _sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== UTILIDADES ======
    const $ = (id)=>document.getElementById(id);
    const estado = $("estado");
    const form = $("form-reserva");
    const listaMesas = $("lista-mesas");
    const selectMesa = $("mesa");
    const cantidadSel = $("cantidad");
    const inptSoc = $("cupos_socios"), inptInv = $("cupos_invitados");
    const responsableAsiste = $("responsable_asiste");
    const accionResp = $("accion_responsable");

    const boxSoc = $("datos-socios"), boxInv = $("datos-invitados");
    const lblSuma = $("suma-cupos");

    const copiarBtns = ()=>document.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        try{await navigator.clipboard.writeText(btn.dataset.copy);btn.textContent='Copiado';setTimeout(()=>btn.textContent='Copiar',1500);}catch(err){alert('No se pudo copiar');}
      });
    });

    // ====== MESAS: cargar todas con estado (excluye mesa 2 en selector) ======
    let cacheMesas = [];
    async function cargarMesas(){
      selectMesa.innerHTML = '<option value="" selected disabled>Cargando mesas…</option>';
      listaMesas.innerHTML = '';
      const { data, error } = await _sb.from('mesas').select('id,nombre,aforo,reservados').order('id',{ascending:true});
      if(error){ console.error(error); selectMesa.innerHTML = '<option value="" disabled>Error cargando mesas</option>'; return; }
      cacheMesas = data;

      // Construye lista completa con badges
      for(const m of data){
        const cupos = Math.max(0,(m.aforo||0)-(m.reservados||0));
        const nom = m.nombre ? ` – ${m.nombre}` : '';
        let badge = `<span class="badge b-ok">${cupos} disp.</span>`;
        if(m.id===2){ badge = `<span class="badge b-block">Bloqueada</span>`; }
        else if(cupos===0){ badge = `<span class="badge b-err">LLENA</span>`; }
        else if(cupos<=3){ badge = `<span class="badge b-warn">${cupos} disp.</span>`; }
        const li = document.createElement('li');
        li.innerHTML = `Mesa <strong>${m.id}</strong>${nom}: ${badge}`;
        listaMesas.appendChild(li);
      }

      // Selector: solo mesas con cupos > 0 y que no sean la 2
      const disponibles = data
        .filter(m => m.id !== 2)
        .map(m => ({ ...m, cupos: Math.max(0,(m.aforo||0)-(m.reservados||0)) }))
        .filter(m => m.cupos > 0);

      if(disponibles.length === 0){
        selectMesa.innerHTML = '<option value="" disabled>Sin mesas disponibles</option>';
      }else{
        selectMesa.innerHTML = '<option value="" selected disabled>Selecciona una mesa</option>';
        for(const m of disponibles){
          const opt = document.createElement('option');
          opt.value = m.id;
          const nom = m.nombre ? ` – ${m.nombre}` : '';
          opt.textContent = `Mesa ${m.id}${nom} — ${m.cupos} cupos disponibles`;
          selectMesa.appendChild(opt);
        }
      }
    }

    // ====== Lógica de cupos (incluye responsable) ======
    function extraResponsable(){ return responsableAsiste.checked ? 1 : 0; }

    function validarSuma(){
      const total = Number(cantidadSel.value||0);
      const s = Number(inptSoc.value||0), i = Number(inptInv.value||0), extra = extraResponsable();
      const suma = s+i+extra;
      lblSuma.textContent = `Seleccionados ${s+i} + ${extra} (responsable) = ${suma} de ${total} cupos`;
      lblSuma.style.color = (suma===total? '#a4a6ad' : '#ff5a5a');
      accionResp.required = responsableAsiste.checked;
      return suma===total && total>=8 && total<=10;
    }

    function renderBloques(){
      // Socios (sin responsable; se agrega auto en el envío)
      boxSoc.innerHTML = '';
      const ns = Number(inptSoc.value||0);
      if(ns>0){
        const title = document.createElement('h3'); title.textContent = `Datos de Socios (${ns})`; title.style.margin='0'; boxSoc.appendChild(title);
        const badge = document.createElement('small'); badge.className='hint'; badge.textContent = responsableAsiste.checked ? 'El socio responsable se registrará automáticamente con los datos de la parte superior.' : 'El responsable no se contará en esta reserva.'; boxSoc.appendChild(badge);
        for(let x=1;x<=ns;x++){
          const wrap=document.createElement('div'); wrap.className='grid grid-2';
          wrap.innerHTML = `
            <div><label for="socio_nombre_${x}">Socio ${x} – Nombre</label><input id="socio_nombre_${x}" required /></div>
            <div><label for="socio_apellido_${x}">Socio ${x} – Apellido</label><input id="socio_apellido_${x}" required /></div>
            <div><label for="socio_cel_${x}">Socio ${x} – Celular/WhatsApp</label><input id="socio_cel_${x}" inputmode="tel" required /></div>
            <div><label for="socio_accion_${x}">Socio ${x} – N.º de acción/cupo</label><input id="socio_accion_${x}" required /></div>`;
          boxSoc.appendChild(wrap);
        }
      }
      // Invitados
      boxInv.innerHTML = '';
      const ni = Number(inptInv.value||0);
      if(ni>0){
        const title = document.createElement('h3'); title.textContent = `Datos de Invitados (${ni})`; title.style.margin='0'; boxInv.appendChild(title);
        for(let x=1;x<=ni;x++){
          const wrap=document.createElement('div'); wrap.className='grid grid-2';
          wrap.innerHTML = `
            <div><label for="inv_tipo_${x}">Invitado ${x} – Tipo de documento</label>
              <select id="inv_tipo_${x}" required><option value="">Selecciona…</option><option>CC</option><option>TI</option><option>CE</option><option>PAS</option><option>Otro</option></select>
            </div>
            <div><label for="inv_doc_${x}">Invitado ${x} – Número de documento</label><input id="inv_doc_${x}" required /></div>
            <div><label for="inv_pnom_${x}">Invitado ${x} – Primer Nombre</label><input id="inv_pnom_${x}" required /></div>
            <div><label for="inv_snom_${x}">Invitado ${x} – Segundo Nombre</label><input id="inv_snom_${x}" /></div>
            <div><label for="inv_pape_${x}">Invitado ${x} – Primer Apellido</label><input id="inv_pape_${x}" required /></div>
            <div><label for="inv_sape_${x}">Invitado ${x} – Segundo Apellido</label><input id="inv_sape_${x}" /></div>
            <div><label for="inv_cor_${x}">Invitado ${x} – Correo electrónico</label><input id="inv_cor_${x}" type="email" required /></div>
            <div><label for="inv_cel_${x}">Invitado ${x} – Número de celular</label><input id="inv_cel_${x}" inputmode="tel" required /></div>`;
          boxInv.appendChild(wrap);
        }
      }
      actualizarPago();
    }

    function actualizarPago(){
      const invitados = Number(inptInv.value||0);
      const total = invitados * 250000;
      const fmt = (n)=> n.toLocaleString('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 });
      document.getElementById('resumen-pago').innerHTML = `${invitados} invitados × $250.000 = <strong>${fmt(total)}</strong>`;
      return total;
    }

    // Listeners
    ['change','input'].forEach(evt=>{
      [cantidadSel,inptSoc,inptInv,selectMesa,responsableAsiste,$("nombres"),$("mesa")].forEach(el=> el.addEventListener(evt,()=>{validarSuma();renderBloques();updateWhatsAppLink();}));
    });

    function updateWhatsAppLink(){
      const nombre = encodeURIComponent($("nombres").value || '');
      const mesaTxt = selectMesa.options[selectMesa.selectedIndex]?.text || '';
      const cant = encodeURIComponent(cantidadSel.value || '');
      const msg = `Hola, quiero reservar ${mesaTxt} para ${cant} personas. Responsable: ${decodeURIComponent(nombre)}.`;
      $("btn-whatsapp").href = 'https://wa.me/573127596112?text=' + encodeURIComponent(msg);
    }

    copiarBtns();

    // ====== SUBMIT ======
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const cantidad = Number(cantidadSel.value||0);
      if(!(cantidad>=8 && cantidad<=10)){
        estado.textContent = 'Debes reservar mínimo 8 y máximo 10 puestos por mesa.';
        estado.className='danger';
        return;
      }
      if(!validarSuma()){
        estado.textContent='La distribución de cupos debe sumar exactamente la cantidad seleccionada (incluido el responsable).'; 
        estado.className='danger'; 
        return;
      }
      if(!selectMesa.value){
        estado.textContent='Selecciona una mesa disponible.'; 
        estado.className='danger'; 
        return;
      }

      $("btn-enviar").disabled = true; estado.textContent='Procesando…'; estado.className='hint';
      try{
        const socios=[], invitados=[];
        // Socios manuales
        for(let x=1;x<=Number(inptSoc.value||0);x++){
          socios.push({ nombre: $("socio_nombre_"+x)?.value, apellido: $("socio_apellido_"+x)?.value, celular: $("socio_cel_"+x)?.value, accion: $("socio_accion_"+x)?.value });
        }
        // Responsable como socio si asiste
        if(responsableAsiste.checked){
          const full = $("nombres").value.trim();
          let nombre = full, apellido = '';
          if(full.includes(' ')){ const parts = full.split(' '); apellido = parts.pop(); nombre = parts.join(' '); }
          socios.unshift({ nombre, apellido: apellido || null, celular: $("contacto").value, accion: accionResp.value || null, responsable: true });
        }
        // Invitados
        for(let x=1;x<=Number(inptInv.value||0);x++){
          invitados.push({ tipo: $("inv_tipo_"+x).value, documento: $("inv_doc_"+x).value, pnombre: $("inv_pnom_"+x).value, snombre: $("inv_snom_"+x).value||null, papellido: $("inv_pape_"+x).value, sapellido: $("inv_sape_"+x).value||null, correo: $("inv_cor_"+x).value, celular: $("inv_cel_"+x).value });
        }

        const grupo = { socios, invitados, total: cantidad, responsable_incluido: responsableAsiste.checked };
        const mesaId = Number(selectMesa.value);
        const mesaNombre = (cacheMesas.find(m=>m.id===mesaId)?.nombre) || null;
        const eventoMeta = { mesa: { id: mesaId, nombre: mesaNombre } };

        // Modo prueba
        if($("demo").checked){
          const totalPago = actualizarPago();
          const fmt = (n)=> n.toLocaleString('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 });
          estado.innerHTML = `✅ <strong>Simulación</strong> sin afectar cupos.<br> Mesa: <strong>${mesaId}${mesaNombre? ' – '+mesaNombre : ''}</strong>. Total a pagar por invitados: <strong>${fmt(totalPago)}</strong>.`;
          estado.className = 'ok';
          return;
        }

        // Real
        const { data, error } = await _sb.rpc('reserve_seats_v2', {
          p_mesa_id: mesaId,
          p_cantidad: cantidad,
          p_responsable: $("nombres").value,
          p_contacto: $("contacto").value,
          p_correo: $("correo").value,
          p_pago_url: null,
          p_invitado: grupo,
          p_evento: eventoMeta
        });

        if(error){
          if((error.message||'').includes('SIN_CUPO')){
            estado.textContent='La mesa no tiene cupo suficiente o se ocupó durante el proceso.'; 
            estado.className='danger'; 
            $("btn-enviar").disabled=false; 
            await cargarMesas();
            return;
          }
          throw error;
        }

        const totalPago = actualizarPago();
        const fmt = (n)=> n.toLocaleString('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:0 });
        estado.innerHTML = `¡Reserva registrada! ID: <strong>${data}</strong>. Mesa: <strong>${mesaId}${mesaNombre? ' – '+mesaNombre : ''}</strong>. Total a pagar por invitados: <strong>${fmt(totalPago)}</strong>.`;
        estado.className = 'ok';
        updateWhatsAppLink();
        await cargarMesas();
      }catch(err){
        console.error(err);
        estado.textContent='Ocurrió un error al reservar. Intenta de nuevo.';
        estado.className='danger';
      } finally {
        $("btn-enviar").disabled=false;
      }
    });

    // Init
    cargarMesas();
    validarSuma(); renderBloques(); copiarBtns();
  </script>
</body>
</html>
