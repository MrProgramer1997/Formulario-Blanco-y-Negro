<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reserva – Fiesta Blanco & Negro</title>
  <meta name="description" content="Formulario de reservas – GitHub Pages + Supabase"/>

  <style>
    :root{--bg:#0b0b0d;--card:#141418;--muted:#a4a6ad;--text:#f1f1f3;--accent:#ffffff;--ok:#1aa34a;--warn:#f6c445;--err:#ff5a5a}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;line-height:1.45}
    .wrap{max-width:1000px;margin:auto;padding:20px}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b0b0de6,#0b0b0d00);backdrop-filter:saturate(150%) blur(2px);z-index:5}
    .title{display:flex;align-items:center;gap:16px}
    .title h1{font-size:clamp(22px,3.2vw,34px);margin:0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #2c2f36;border-radius:999px;background:#0f1013;color:var(--muted);font-size:12px}
    .card{background:var(--card);border:1px solid #22242a;border-radius:16px;padding:20px;box-shadow:0 10px 30px #00000040}
    .grid{display:grid;gap:16px}
    @media (min-width:860px){.grid-2{grid-template-columns:1fr 1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2c2f36;background:#0f1013;color:var(--text);outline:none}
    input:focus,select:focus,textarea:focus{border-color:#5c6cff;box-shadow:0 0 0 3px #5c6cff30}
    small.hint{color:var(--muted);display:block}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid #2c2f36;background:#101217;color:var(--text);padding:12px 16px;border-radius:12px;cursor:pointer;text-decoration:none;font-weight:600}
    .btn:hover{background:#151826}
    .btn.primary{background:#5c6cff;border-color:#5c6cff;color:#fff}
    .ok{color:var(--ok)} .danger{color:var(--err)} .muted{color:var(--muted)}
    .bank{display:grid;gap:10px}
    .bank .item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:12px;border-radius:12px;background:#0f1013;border:1px solid #2c2f36}
    .alert{border-left:4px solid var(--warn);background:#17130a;border-radius:12px;padding:12px 14px}
    footer{color:var(--muted);text-align:center;padding:30px 10px}

    /* ====== PLANO INTERACTIVO ====== */
    .map-wrap{position:relative;border-radius:16px;overflow:hidden;border:1px solid #22242a}
    .map-img{width:100%;display:block}
    .overlay{position:absolute;inset:0}
    .mesa{position:absolute;border:2px solid transparent;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900}
    .mesa .n{font-size:14px;text-shadow:0 1px 2px #0009}
    .mesa.m-ok{background:#1aa34aCC;border-color:#0c7a35AA}
    .mesa.m-warn{background:#f6c445CC;border-color:#b68900AA;color:#000}
    .mesa.m-err{background:#ff5a5aCC;border-color:#b30000AA}
    .mesa:hover{outline:3px solid #ffffff55}
    .mesa.selected{outline:4px solid #6da3ff; box-shadow:0 0 0 6px #6da3ff30}
    .mesa.selected .n{color:#fff}

    /* Lista desplegable estado de mesas */
    details.state {background:#0f1013;border:1px solid #2c2f36;border-radius:12px;padding:12px}
    details.state > summary{cursor:pointer;font-weight:700;list-style:none}
    details.state > summary::-webkit-details-marker{display:none}
    .state-list{margin:10px 0 0 0;padding-left:18px;max-height:420px;overflow:auto}
    .state-item{display:flex;gap:8px;align-items:center;margin:6px 0}
    .dot{width:8px;height:8px;border-radius:99px;display:inline-block}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--err)}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#0f1013;border:1px solid #2c2f36}
    .tag.ok{background:#0d2;color:#001} .tag.warn{background:#fb0;color:#000} .tag.err{background:#f55;color:#fff}

    /* Bloque consentimiento + botón juntos */
    .consent{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .consent .btn{margin-left:auto}
  </style>

  <!-- Supabase SDK v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="wrap">
  <div class="title">
    <img src="./assets/plano-blanco-negro.jpg" alt="Plano de ubicación de mesas" style="width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid #2c2f36"/>
    <div>
      <h1>Reserva de mesas · Fiesta Blanco & Negro</h1>
      <div class="row">
        <span class="pill">Sábado 22 de noviembre</span>
        <span class="pill">Salón Rialto & Lobby</span>
        <span class="pill">Horario: 7:00 p.m. – 5:00 a.m.</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap grid" style="margin-top:14px">
  <!-- MAPA + OVERLAY -->
  <section class="card grid">
    <div class="map-wrap" id="map-wrap">
      <img src="./assets/plano-blanco-negro.jpg" alt="Plano de mesas" class="map-img" id="map-img"/>
      <div class="overlay" id="overlay" aria-live="polite"></div>
    </div>
    <small class="muted">Haz clic sobre una mesa <strong>disponible</strong> para seleccionarla. La ubicación puede variar por montaje.</small>

    <!-- Lista desplegable de estado -->
    <details class="state" id="estado-mesas" open>
      <summary>Estado de mesas</summary>
      <div id="state-list" class="state-list"></div>
    </details>
  </section>

  <!-- ALERTA PENALIDAD -->
  <section class="card alert">
    <strong>Importante:</strong> En el caso de reservar y no asistir, el club facturará dentro de la cuota de sostenimiento, un valor de <strong>$200.000</strong> por persona.
  </section>

  <!-- FORMULARIO -->
  <section class="card">
    <h2 style="margin-top:0">Formulario de reserva</h2>
    <form id="form-reserva">
      <div class="grid grid-2">
        <div>
          <label for="nombres">Nombre del responsable</label>
          <input id="nombres" name="nombres" required placeholder="Nombre y apellido"/>
        </div>
        <div>
          <label for="contacto">Teléfono / WhatsApp</label>
          <input id="contacto" name="contacto" inputmode="tel" placeholder="312 759 6112" required/>
        </div>
        <div>
          <label for="correo">Correo electrónico</label>
          <input id="correo" type="email" name="correo" placeholder="correo@ejemplo.com" required/>
        </div>
        <div>
          <label for="mesa">Número de mesa</label>
          <input id="mesa" name="mesa" placeholder="Haz clic en el plano" readonly required/>
          <small id="mesa-hint" class="hint muted"></small>
        </div>
        <div>
          <label for="cantidad">Cantidad de puestos a reservar</label>
          <select id="cantidad" name="cantidad" required>
            <option value="" selected disabled>Selecciona (mínimo 8)</option>
            <option value="8">8</option><option value="9">9</option><option value="10">10</option>
          </select>
          <small class="hint">Cada mesa tiene máximo 10 puestos.</small>
        </div>
        <div>
          <label>¿El responsable también asiste?</label>
          <select id="resp-asiste">
            <option value="si" selected>Sí</option>
            <option value="no">No</option>
          </select>
          <small class="hint">Si asiste, se descuenta 1 cupo como <strong>Socio</strong> y se pide N.º de acción.</small>
        </div>
      </div>

      <!-- DISTRIBUCIÓN -->
      <div class="card" style="background:#0f1013;border:1px dashed #2c2f36;margin-top:10px">
        <label style="font-weight:700">Distribuye los cupos</label>
        <div class="grid grid-2">
          <div>
            <label for="cupos_socios">Cupos para Socios</label>
            <input id="cupos_socios" type="number" min="0" max="10" value="1"/>
            <small class="hint">Se descuenta automáticamente si el responsable asiste.</small>
          </div>
          <div>
            <label for="cupos_invitados">Cupos para Invitados</label>
            <input id="cupos_invitados" type="number" min="0" max="10" value="0"/>
          </div>
          <div>
            <small class="hint" id="suma-cupos">Debe sumar exactamente la cantidad seleccionada.</small>
          </div>
        </div>
      </div>

      <!-- DATOS DETALLADOS -->
      <div id="bloques-datos" class="grid" style="margin-top:8px">
        <div id="datos-socios" class="grid"></div>
        <div id="datos-invitados" class="grid"></div>
      </div>

      <!-- COSTO -->
      <div class="grid grid-2" style="margin-top:8px">
        <div>
          <label>Total a pagar por Invitados</label>
          <div class="card" style="padding:12px;background:#0f1013;border:1px solid #2c2f36">
            <div id="resumen-pago" class="row">0 invitados × $250.000 = <strong>$0</strong></div>
            <small class="hint">Socios: $0 según protocolo.</small>
          </div>
        </div>
        <div>
          <label>Transferencias</label>
          <div class="bank">
            <div class="item"><span>Davivienda • CC <strong>126669999149</strong></span><a class="btn" href="https://www.davivienda.com/" target="_blank" rel="noopener">Ir a Davivienda</a></div>
            <div class="item"><span>Bancolombia • CC <strong>07322164601</strong></span><a class="btn" href="https://www.bancolombia.com/" target="_blank" rel="noopener">Ir a Bancolombia</a></div>
          </div>
        </div>
      </div>

      <!-- CONSENTIMIENTO + ENVIAR -->
      <div class="consent" style="margin-top:14px">
        <label class="row" style="gap:10px;align-items:flex-start">
          <input id="acepto" type="checkbox" required/>
          <span>Confirmo que reservo mínimo 8 puestos y acepto que, en caso de no asistir, se cobrará $200.000 por persona en mi cuota de sostenimiento.</span>
        </label>
        <button class="btn primary" type="submit" id="btn-enviar" disabled>Reservar mesa</button>
      </div>

      <p id="estado" class="hint" style="margin-top:10px"></p>
    </form>
  </section>

  <!-- PROTOCOLO -->
  <section class="card grid">
    <h3 style="margin:0">Protocolo y condiciones</h3>
    <ul>
      <li><strong>Código de vestuario:</strong> Blanco / negro.</li>
      <li>Mujeres: vestido o conjunto de pantalón elegante.</li>
      <li>Hombres: pantalón y camisa.</li>
      <li>Edad mínima: 18 años.</li>
      <li>Valor por persona: corporado $0; invitado $250.000.</li>
      <li>Acomodación: mesas rectangulares de 8 (máx. 10) en Salón Rialto y Lobby. Para grupos de 2–7, WhatsApp 3127596112.</li>
      <li>Reservas/cancelaciones hasta jueves 20 de noviembre o hasta agotar disponibilidad.</li>
      <li>Pasos: (1) elige mesa; (2) completa el formulario; (3) paga invitados y registra en oficina de eventos con el soporte.</li>
      <li>En caso de no cumplir con el mínimo de puestos, el club podrá reubicar su grupo.</li>
      <li>La ubicación de mesas puede cambiar según necesidades de montaje.</li>
    </ul>
  </section>
</main>

<footer>© Club Campestre Pereira – Fiesta Blanco & Negro</footer>

<script>
/* ===== Configuración Supabase ===== */
const SUPABASE_URL = "https://cmrydhzpcuklfvigboka.supabase.co";        // <-- tu proyecto
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtcnlkaHpwY3VrbGZ2aWdib2thIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzU1NDIsImV4cCI6MjA3ODExMTU0Mn0.SzLh-CoahU63AISJwPKJLJkAf-JQ2qxAwUt69NsPKgQ";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Utilidades ===== */
const $ = (id)=>document.getElementById(id);
const overlay = $("overlay");
const stateList = $("state-list");
const mesaInput = $("mesa");
const mesaHint = $("mesa-hint");
const cantidadSel = $("cantidad");
const inptSoc = $("cupos_socios"), inptInv = $("cupos_invitados");
const boxSoc = $("datos-socios"), boxInv = $("datos-invitados");
const lblSuma = $("suma-cupos");
const form = $("form-reserva");
const btnEnviar = $("btn-enviar");
const respAsiste = $("resp-asiste");
const estado = $("estado");

let COORDS = [];         // desde /assets/mesas-coords.json
let MESAS = [];          // desde supabase (id, nombre, aforo, reservados)
let selectedMesa = null; // {id, libres}
let mesaTopUpInfo = null; // {reservados, libres, contacto?, correo?}

/* ===== Plano: cargar coords + mesas ===== */
async function loadCoords(){
  const r = await fetch("./assets/mesas-coords.json?ts="+Date.now());
  COORDS = await r.json();
}

async function loadMesas(){
  const { data, error } = await sb.from("mesas").select("id,nombre,aforo,reservados").order("id");
  if(error){ console.error(error); return; }
  MESAS = data || [];
}

/* ===== Render overlay ===== */
function renderOverlay(){
  overlay.innerHTML = "";
  COORDS.forEach(c=>{
    const info = MESAS.find(x=>x.id===c.id) || {aforo:10,reservados:0,nombre:""};
    const libres = Math.max(0, (info.aforo||10) - (info.reservados||0));
    let cls = "m-ok";
    if(libres===0) cls = "m-err";
    else if(libres<=2) cls = "m-warn";
    const div = document.createElement("div");
    div.className = `mesa ${cls}`;
    div.style.left   = (c.left)+"%";
    div.style.top    = (c.top)+"%";
    div.style.width  = (c.width)+"%";
    div.style.height = (c.height)+"%";
    div.dataset.id = c.id;
    div.title = `Mesa ${c.id} – libres: ${libres}`;
    div.innerHTML = `<span class="n">${c.id}</span>`;
    if(selectedMesa && selectedMesa.id===c.id) div.classList.add("selected");
    if(libres===0){
      div.style.pointerEvents="none";
      div.title = `Mesa ${c.id} – llena`;
    }
    div.addEventListener("click", ()=> selectMesa(c.id, libres));
    overlay.appendChild(div);
  });
}

/* ===== Lista desplegable de estado ===== */
function renderStateList(){
  stateList.innerHTML = "";
  MESAS.forEach(m=>{
    const libres = Math.max(0, (m.aforo||10) - (m.reservados||0));
    let cls="ok", txt="Disponible";
    if(libres===0){ cls="err"; txt="LLENA"; }
    else if(libres<=2){ cls="warn"; txt="Pocos cupos"; }
    const li = document.createElement("div");
    li.className = "state-item";
    li.innerHTML = `
      <span class="dot ${cls}"></span>
      <span>Mesa ${m.id} – ${m.nombre||"Salón"}</span>
      <span class="tag ${cls}" style="margin-left:auto">${txt} (${libres})</span>
    `;
    stateList.appendChild(li);
  });
}

/* ===== Cargar info para top-up y ajustar selector de cantidad ===== */
async function loadMesaTopUpInfo(id){
  mesaTopUpInfo = null;
  const info = MESAS.find(x=>x.id===id) || {reservados:0, aforo:10};
  const libres = Math.max(0,(info.aforo||10)-(info.reservados||0));
  mesaTopUpInfo = {reservados: info.reservados||0, libres};

  // Si está en ventana de top-up (>=8 y <10), tomamos el contacto/correo del primer registro
  if(info.reservados>=8 && info.reservados<10){
    const { data } = await sb
      .from('reservas')
      .select('texto_contacto,texto_correo,created_at')
      .eq('mesa_id', id)
      .order('created_at', {ascending:true})
      .limit(1);
    if(data && data.length){
      mesaTopUpInfo.contacto = data[0].texto_contacto || null;
      mesaTopUpInfo.correo   = data[0].texto_correo   || null;
    }
  }
  setupCantidadOptions();
  checkTopUpAuth(); // valida en caso de top-up
}

function setupCantidadOptions(){
  const sel = cantidadSel;
  const info = mesaTopUpInfo;
  const selected = sel.value;
  sel.innerHTML = '';

  if(!info || (info.reservados||0)===0){
    sel.innerHTML = `
      <option value="" selected disabled>Selecciona (mínimo 8)</option>
      <option value="8">8</option><option value="9">9</option><option value="10">10</option>
    `;
  } else if(info.reservados>=8 && info.reservados<10){
    const header = document.createElement('option');
    header.disabled = true; header.selected = true;
    header.textContent = `Quedan ${info.libres} cupo(s)`;
    sel.appendChild(header);
    for(let n=1;n<=info.libres;n++){
      const o=document.createElement('option'); o.value=String(n); o.textContent=String(n); sel.appendChild(o);
    }
    mesaHint.textContent = `Mesa en progreso: ${info.reservados}/10 ocupados. Solo el responsable puede completar los ${info.libres} cupo(s).`;
  } else if(info.reservados>=10){
    const header = document.createElement('option');
    header.disabled = true; header.selected = true; header.textContent = `Mesa llena`;
    sel.appendChild(header);
  }

  // intenta preservar selección si aplica
  const opt = [...sel.options].find(o=>o.value===selected);
  if(opt) sel.value = selected;
}

/* ===== Validación de identidad para top-up ===== */
function checkTopUpAuth(){
  // Solo aplica si ya hay 8-9 reservados
  if(!mesaTopUpInfo || !(mesaTopUpInfo.reservados>=8 && mesaTopUpInfo.reservados<10)){
    estado.textContent=''; estado.className='hint'; return;
  }
  const tel = $("contacto").value?.trim() || '';
  const cor = $("correo").value?.trim().toLowerCase() || '';
  const ok =
    (mesaTopUpInfo.contacto && tel && tel === String(mesaTopUpInfo.contacto).trim()) ||
    (mesaTopUpInfo.correo && cor && cor === String(mesaTopUpInfo.correo).trim().toLowerCase());

  if(!ok){
    estado.className='danger';
    estado.textContent='Los cupos restantes solo pueden ser completados por la misma persona que inició la reserva (mismo WhatsApp o correo).';
    btnEnviar.disabled = true;
  }else{
    estado.textContent=''; estado.className='hint';
    validateAll();
  }
}

/* ===== Seleccionar mesa ===== */
async function selectMesa(id, libres){
  selectedMesa = { id, libres };
  mesaInput.value = String(id);
  const info = MESAS.find(x=>x.id===id) || {reservados:0, aforo:10};
  const disp = Math.max(0,(info.aforo||10)-(info.reservados||0));
  mesaHint.textContent = (disp>0) ? `Mesa ${id} seleccionada. Cupos libres: ${disp}` : "Mesa sin cupo";
  await loadMesaTopUpInfo(id);
  renderOverlay(); // re-pinta con .selected
  form.scrollIntoView({behavior:"smooth", block:"start"});
  validateAll();
}

/* ===== Bloques dinámicos (socios/invitados) ===== */
function renderBloques(){
  const total = Number(cantidadSel.value||0);
  const asiste = (respAsiste.value==="si");
  let s = Math.min(10, Math.max(0, Number(inptSoc.value||0)));
  let i = Math.min(10, Math.max(0, Number(inptInv.value||0)));
  if(asiste){
    if(s===0) s=1;
    inptSoc.value = s;
  }
  const suma = s+i;
  lblSuma.textContent = `Seleccionados ${suma} de ${total} cupos`;
  lblSuma.style.color = (suma===total? '#a4a6ad' : '#ff5a5a');

  // SOCIOS: solo Nombre completo + N° de acción/cupo
  boxSoc.innerHTML = "";
  if(s>0){
    const title=document.createElement("h3");
    title.textContent=`Datos de Socios (${s})`; title.style.margin='0 0 6px 0';
    boxSoc.appendChild(title);
    for(let x=1;x<=s;x++){
      const wrap=document.createElement('div'); wrap.className='grid grid-2';
      const pre = (x===1 && respAsiste.value==="si") ? " – Responsable" : "";
      wrap.innerHTML = `
        <div><label>Socio ${x}${pre} – Nombre completo</label><input id="socio_nombre_${x}" required /></div>
        <div><label>Socio ${x}${pre} – N.º de acción/cupo</label><input id="socio_accion_${x}" required /></div>
      `;
      boxSoc.appendChild(wrap);
    }
    // Prellenar responsable si asiste
    if(respAsiste.value==="si"){
      $("socio_nombre_1").value = $("nombres").value || "";
    }
  }

  // INVITADOS (sin cambios)
  boxInv.innerHTML = "";
  if(i>0){
    const title=document.createElement("h3"); title.textContent=`Datos de Invitados (${i})`; title.style.margin='0 0 6px 0'; boxInv.appendChild(title);
    for(let x=1;x<=i;x++){
      const wrap=document.createElement('div'); wrap.className='grid grid-2';
      wrap.innerHTML = `
        <div><label>Invitado ${x} – Tipo de documento</label>
          <select id="inv_tipo_${x}" required><option value="">Selecciona…</option><option>CC</option><option>TI</option><option>CE</option><option>PAS</option><option>Otro</option></select>
        </div>
        <div><label>Invitado ${x} – Número de documento</label><input id="inv_doc_${x}" required /></div>
        <div><label>Invitado ${x} – Primer Nombre</label><input id="inv_pnom_${x}" required /></div>
        <div><label>Invitado ${x} – Segundo Nombre</label><input id="inv_snom_${x}" /></div>
        <div><label>Invitado ${x} – Primer Apellido</label><input id="inv_pape_${x}" required /></div>
        <div><label>Invitado ${x} – Segundo Apellido</label><input id="inv_sape_${x}" /></div>
        <div><label>Invitado ${x} – Correo electrónico</label><input id="inv_cor_${x}" type="email" required /></div>
        <div><label>Invitado ${x} – Número de celular</label><input id="inv_cel_${x}" inputmode="tel" required /></div>
      `;
      boxInv.appendChild(wrap);
    }
  }
  actualizarPago();
  validateAll();
}

/* ===== Pago invitados ===== */
function actualizarPago(){
  const invitados = Math.min(10, Math.max(0, Number(inptInv.value||0)));
  const total = invitados * 250000;
  const fmt = (n)=> n.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
  document.getElementById('resumen-pago').innerHTML = `${invitados} invitado${invitados===1?'':'s'} × $250.000 = <strong>${fmt(total)}</strong>`;
  return total;
}

/* ===== Validaciones globales ===== */
function validateAll(){
  const cantidad = Number(cantidadSel.value||0);
  const s = Math.min(10, Math.max(0, Number(inptSoc.value||0)));
  const i = Math.min(10, Math.max(0, Number(inptInv.value||0)));

  // si es top-up permitimos 1..libres, si no, mínimo 8
  const topUp = mesaTopUpInfo && mesaTopUpInfo.reservados>=8 && mesaTopUpInfo.reservados<10;
  const cantidadOK = topUp ? (cantidad>=1 && cantidad<= (mesaTopUpInfo?.libres||0)) : (cantidad>=8 && cantidad<=10);

  const sumaOK = (s+i) === cantidad && cantidadOK;
  const mesaOK = !!mesaInput.value;
  const checkOK = $("acepto").checked;

  const pass = (sumaOK && mesaOK && checkOK);
  btnEnviar.disabled = !pass;

  if(topUp) checkTopUpAuth(); // puede volver a deshabilitar si no coincide identidad
}

/* ===== Envío ===== */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(btnEnviar.disabled) return;
  btnEnviar.disabled = true; estado.textContent='Procesando…'; estado.className='hint';
  try{
    const cantidad = Number(cantidadSel.value||0);
    const socios=[], invitados=[];
    for(let x=1;x<=Number(inptSoc.value||0);x++){
      socios.push({
        nombre: $("socio_nombre_"+x)?.value||"",
        accion: $("socio_accion_"+x)?.value||""
      });
    }
    for(let x=1;x<=Number(inptInv.value||0);x++){
      invitados.push({
        tipo: $("inv_tipo_"+x)?.value||"",
        documento: $("inv_doc_"+x)?.value||"",
        pnombre: $("inv_pnom_"+x)?.value||"",
        snombre: $("inv_snom_"+x)?.value||null,
        papellido: $("inv_pape_"+x)?.value||"",
        sapellido: $("inv_sape_"+x)?.value||null,
        correo: $("inv_cor_"+x)?.value||"",
        celular: $("inv_cel_"+x)?.value||""
      });
    }
    const grupo = { socios, invitados, total:cantidad, resp_asiste: (respAsiste.value==="si") };

    const { data, error } = await sb.rpc('reserve_seats_v2',{
      p_mesa_id: Number(mesaInput.value),
      p_cantidad: cantidad,
      p_responsable: $("nombres").value,
      p_contacto: $("contacto").value,
      p_correo: $("correo").value,
      p_pago_url: null,
      p_invitado: grupo,
      p_evento: null
    });

    if(error){
      if((error.message||'').includes('SIN_CUPO')){
        estado.textContent='La mesa no tiene cupo suficiente (alguien la tomó antes).'; estado.className='danger';
        await reloadAll(); btnEnviar.disabled=false; return;
      }
      throw error;
    }
    const totalPago = actualizarPago();
    const fmt = (n)=> n.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
    estado.innerHTML = `¡Reserva registrada! Total a pagar por invitados: <strong>${fmt(totalPago)}</strong>.`;
    estado.className='ok';
    await reloadAll();
  }catch(err){
    console.error(err);
    estado.textContent='Ocurrió un error al reservar. Intenta de nuevo.'; estado.className='danger';
  }finally{
    btnEnviar.disabled=false;
  }
});

/* ===== Eventos UI ===== */
["change","input"].forEach(evt=>{
  [cantidadSel,inptSoc,inptInv,respAsiste].forEach(el=> el.addEventListener(evt, renderBloques));
  ["nombres","contacto","correo"].forEach(id=> $(id).addEventListener(evt, ()=>{ renderBloques(); checkTopUpAuth(); }));
  $("acepto").addEventListener(evt, validateAll);
});

/* ===== Auto refresh ===== */
async function reloadAll(){
  await loadMesas();
  renderOverlay();
  renderStateList();
  if(selectedMesa){ await loadMesaTopUpInfo(selectedMesa.id); }
}
setInterval(reloadAll, 15000);

/* ===== Inicio ===== */
(async()=>{
  await loadCoords();
  await reloadAll();
  renderBloques();
})();
</script>
</body>
</html>
