<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reserva â€“ Fiesta Blanco & Negro</title>
  <meta name="description" content="Formulario de reservas â€“ GitHub Pages + Supabase"/>

  <style>
    :root{--bg:#0b0b0d;--card:#141418;--muted:#a4a6ad;--text:#f1f1f3;--accent:#ffffff;--ok:#1aa34a;--warn:#f6c445;--err:#ff5a5a}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;line-height:1.45}
    .wrap{max-width:1000px;margin:auto;padding:20px}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b0b0de6,#0b0b0d00);backdrop-filter:saturate(150%) blur(2px);z-index:5}
    .title{display:flex;align-items:center;gap:16px}
    .title h1{font-size:clamp(22px,3.2vw,34px);margin:0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #2c2f36;border-radius:999px;background:#0f1013;color:var(--muted);font-size:12px}
    .card{background:var(--card);border:1px solid #22242a;border-radius:16px;padding:20px;box-shadow:0 10px 30px #00000040}
    .grid{display:grid;gap:16px}
    @media (min-width:860px){.grid-2{grid-template-columns:1fr 1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2c2f36;background:#0f1013;color:var(--text);outline:none}
    input:focus,select:focus,textarea:focus{border-color:#5c6cff;box-shadow:0 0 0 3px #5c6cff30}
    small.hint{color:var(--muted);display:block}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid #2c2f36;background:#101217;color:var(--text);padding:12px 16px;border-radius:12px;cursor:pointer;text-decoration:none;font-weight:600}
    .btn:hover{background:#151826}
    .btn.primary{background:#5c6cff;border-color:#5c6cff;color:#fff}
    .ok{color:var(--ok)} .danger{color:var(--err)} .muted{color:var(--muted)}
    .bank{display:grid;gap:10px}
    .bank .item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:12px;border-radius:12px;background:#0f1013;border:1px solid #2c2f36}
    .alert{border-left:4px solid var(--warn);background:#17130a;border-radius:12px;padding:12px 14px}
    footer{color:var(--muted);text-align:center;padding:30px 10px}

    /* ====== PLANO INTERACTIVO ====== */
    .map-wrap{position:relative;border-radius:16px;overflow:hidden;border:1px solid #22242a}
    .map-img{width:100%;display:block}
    .overlay{position:absolute;inset:0}
    .mesa{position:absolute;border:2px solid transparent;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900}
    .mesa .n{font-size:14px;text-shadow:0 1px 2px #0009}
    .mesa.m-ok{background:#1aa34aCC;border-color:#0c7a35AA}
    .mesa.m-warn{background:#f6c445CC;border-color:#b68900AA;color:#000}
    .mesa.m-err{background:#ff5a5aCC;border-color:#b30000AA}
    .mesa:hover{outline:3px solid #ffffff55}
    .mesa.selected{outline:4px solid #6da3ff; box-shadow:0 0 0 6px #6da3ff30}
    .mesa.selected .n{color:#fff}

    /* Lista desplegable estado de mesas */
    details.state {background:#0f1013;border:1px solid #2c2f36;border-radius:12px;padding:12px}
    details.state > summary{cursor:pointer;font-weight:700;list-style:none}
    details.state > summary::-webkit-details-marker{display:none}
    .state-list{margin:10px 0 0 0;padding-left:18px;max-height:420px;overflow:auto}
    .state-item{display:flex;gap:8px;align-items:center;margin:6px 0}
    .dot{width:8px;height:8px;border-radius:99px;display:inline-block}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--err)}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#0f1013;border:1px solid #2c2f36}
    .tag.ok{background:#0d2;color:#001} .tag.warn{background:#fb0;color:#000} .tag.err{background:#f55;color:#fff}

    /* Bloque consentimiento + botÃ³n juntos */
    .consent{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .consent .btn{margin-left:auto}

    /* ===== Controles +/- para mÃ³viles ===== */
    .qty{display:flex;gap:8px;align-items:center}
    .qty input{flex:1}
    .qty-btn{
      width:42px;height:42px;border-radius:10px;border:1px solid #2c2f36;
      background:#0f1013;color:#f1f1f3;font-size:20px;font-weight:700;line-height:1;
      display:flex;align-items:center;justify-content:center;cursor:pointer;
    }
    .qty-btn:active{transform:scale(.98)}
  </style>

  <!-- Supabase SDK v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="wrap">
  <div class="title">
    <img src="./assets/plano-blanco-negro.jpg" alt="Plano de ubicaciÃ³n de mesas" style="width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid #2c2f36"/>
    <div>
      <h1>Reserva de mesas Â· Fiesta Blanco & Negro</h1>
      <div class="row">
        <span class="pill">SÃ¡bado 22 de noviembre</span>
        <span class="pill">SalÃ³n Rialto & Lobby</span>
        <span class="pill">Horario: 7:00 p.m. â€“ 5:00 a.m.</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap grid" style="margin-top:14px">
  <!-- MAPA + OVERLAY -->
  <section class="card grid">
    <div class="map-wrap" id="map-wrap">
      <img src="./assets/plano-blanco-negro.jpg" alt="Plano de mesas" class="map-img" id="map-img"/>
      <div class="overlay" id="overlay" aria-live="polite"></div>
    </div>
    <small class="muted">Haz clic sobre una mesa <strong>disponible</strong> para seleccionarla. La ubicaciÃ³n puede variar por montaje.</small>

    <!-- Lista desplegable de estado -->
    <details class="state" id="estado-mesas" open>
      <summary>Estado de mesas</summary>
      <div id="state-list" class="state-list"></div>
    </details>
  </section>

  <!-- ALERTA PENALIDAD -->
  <section class="card alert">
    <strong>Importante:</strong> En el caso de reservar y no asistir, el club facturarÃ¡ dentro de la cuota de sostenimiento, un valor de <strong>$200.000</strong> por persona.
  </section>

  <!-- FORMULARIO -->
  <section class="card">
    <h2 style="margin-top:0">Formulario de reserva</h2>
    <form id="form-reserva">
      <div class="grid grid-2">
        <div>
          <label for="nombres">Nombre del responsable</label>
          <input id="nombres" name="nombres" required placeholder="Nombre y apellido"/>
        </div>
        <div>
          <label for="contacto">TelÃ©fono / WhatsApp</label>
          <input id="contacto" name="contacto" inputmode="tel" placeholder="312 759 6112" required/>
        </div>
        <div>
          <label for="correo">Correo electrÃ³nico</label>
          <input id="correo" type="email" name="correo" placeholder="correo@ejemplo.com" required/>
        </div>
        <div>
          <label for="mesa">NÃºmero de mesa</label>
          <input id="mesa" name="mesa" placeholder="Haz clic en el plano" readonly required/>
          <small id="mesa-hint" class="hint muted"></small>
        </div>
        <div>
          <label for="cantidad">Cantidad de puestos a reservar</label>
          <select id="cantidad" name="cantidad" required>
            <option value="" selected disabled>Selecciona (mÃ­nimo 8)</option>
            <option value="8">8</option><option value="9">9</option><option value="10">10</option>
          </select>
          <small class="hint">Cada mesa tiene mÃ¡ximo 10 puestos.</small>
        </div>
        <div>
          <label>Â¿El responsable tambiÃ©n asiste?</label>
          <select id="resp-asiste">
            <option value="si" selected>SÃ­</option>
            <option value="no">No</option>
          </select>
          <small class="hint">Si asiste, se descuenta 1 cupo como <strong>Socio</strong> y se pide N.Âº de acciÃ³n.</small>
        </div>
      </div>

      <!-- DISTRIBUCIÃ“N -->
      <div class="card" style="background:#0f1013;border:1px dashed #2c2f36;margin-top:10px">
        <label style="font-weight:700">Distribuye los cupos</label>
        <div class="grid grid-2">
          <div>
            <label for="cupos_socios">Cupos para Socios</label>
            <div class="qty">
              <button type="button" class="qty-btn" data-target="cupos_socios" data-delta="-1">âˆ’</button>
              <input id="cupos_socios" type="number" step="1" min="0" max="10" value="1" inputmode="numeric" pattern="[0-9]*"/>
              <button type="button" class="qty-btn" data-target="cupos_socios" data-delta="+1">+</button>
            </div>
            <small class="hint">Se descuenta automÃ¡ticamente si el responsable asiste.</small>
          </div>
          <div>
            <label for="cupos_invitados">Cupos para Invitados</label>
            <div class="qty">
              <button type="button" class="qty-btn" data-target="cupos_invitados" data-delta="-1">âˆ’</button>
              <input id="cupos_invitados" type="number" step="1" min="0" max="10" value="0" inputmode="numeric" pattern="[0-9]*"/>
              <button type="button" class="qty-btn" data-target="cupos_invitados" data-delta="+1">+</button>
            </div>
          </div>
          <div>
            <small class="hint" id="suma-cupos">Debe sumar exactamente la cantidad seleccionada.</small>
          </div>
        </div>
      </div>

      <!-- DATOS DETALLADOS -->
      <div id="bloques-datos" class="grid" style="margin-top:8px">
        <div id="datos-socios" class="grid"></div>
        <div id="datos-invitados" class="grid"></div>
      </div>

      <!-- COSTO -->
      <div class="grid grid-2" style="margin-top:8px">
        <div>
          <label>Total a pagar por Invitados</label>
          <div class="card" style="padding:12px;background:#0f1013;border:1px solid #2c2f36">
            <div id="resumen-pago" class="row">0 invitados Ã— $250.000 = <strong>$0</strong></div>
            <small class="hint">Socios: $0 segÃºn protocolo.</small>
          </div>
        </div>
        <div>
          <label>Transferencias</label>
          <div class="bank">
            <div class="item"><span>Davivienda â€¢ CC <strong>126669999149</strong></span><a class="btn" href="https://www.davivienda.com/" target="_blank" rel="noopener">Ir a Davivienda</a></div>
            <div class="item"><span>Bancolombia â€¢ CC <strong>07322164601</strong></span><a class="btn" href="https://www.bancolombia.com/" target="_blank" rel="noopener">Ir a Bancolombia</a></div>
          </div>
        </div>
      </div>

      <!-- CONSENTIMIENTO + ENVIAR -->
      <div class="consent" style="margin-top:14px">
        <label class="row" style="gap:10px;align-items:flex-start">
          <input id="acepto" type="checkbox" required/>
          <span>Confirmo que reservo mÃ­nimo 8 puestos y acepto que, en caso de no asistir, se cobrarÃ¡ $200.000 por persona en mi cuota de sostenimiento.</span>
        </label>
        <button class="btn primary" type="submit" id="btn-enviar" disabled>Reservar mesa</button>
      </div>

      <p id="estado" class="hint" style="margin-top:10px"></p>
    </form>
  </section>

  <!-- PROTOCOLO -->
  <section class="card grid">
    <h3 style="margin:0">Protocolo y condiciones</h3>
    <ul>
      <li><strong>CÃ³digo de vestuario:</strong> Blanco / negro.</li>
      <li>Mujeres: vestido o conjunto de pantalÃ³n elegante.</li>
      <li>Hombres: pantalÃ³n y camisa.</li>
      <li>Edad mÃ­nima: 18 aÃ±os.</li>
      <li>Valor por persona: corporado $0; invitado $250.000.</li>
      <li>AcomodaciÃ³n: mesas rectangulares de 8 (mÃ¡x. 10) en SalÃ³n Rialto y Lobby. Para grupos de 2â€“7, WhatsApp 3127596112.</li>
      <li>Reservas/cancelaciones hasta jueves 20 de noviembre o hasta agotar disponibilidad.</li>
      <li>Pasos: (1) elige mesa; (2) completa el formulario; (3) paga invitados y registra en oficina de eventos con el soporte).</li>
      <li>En caso de no cumplir con el mÃ­nimo de puestos, el club podrÃ¡ reubicar su grupo.</li>
      <li>La ubicaciÃ³n de mesas puede cambiar segÃºn necesidades de montaje.</li>
    </ul>
  </section>
</main>

<footer>Â© Club Campestre Pereira â€“ Fiesta Blanco & Negro</footer>

<script>
/* ===== ConfiguraciÃ³n Supabase ===== */
const SUPABASE_URL = "https://cmrydhzpcuklfvigboka.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtcnlkaHpwY3VrbGZ2aWdib2thIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzU1NDIsImV4cCI6MjA3ODExMTU0Mn0.SzLh-CoahU63AISJwPKJLJkAf-JQ2qxAwUt69NsPKgQ";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Utilidades ===== */
const $ = (id)=>document.getElementById(id);
const overlay = $("overlay");
const stateList = $("state-list");
const mesaInput = $("mesa");
const mesaHint = $("mesa-hint");
const cantidadSel = $("cantidad");
const inptSoc = $("cupos_socios"), inptInv = $("cupos_invitados");
const boxSoc = $("datos-socios"), boxInv = $("datos-invitados");
const lblSuma = $("suma-cupos");
const form = $("form-reserva");
const btnEnviar = $("btn-enviar");
const respAsiste = $("resp-asiste");
const estado = $("estado");

let COORDS = [];         // desde /assets/mesas-coords.json
let MESAS = [];          // desde supabase (id, nombre, aforo, reservados)
let selectedMesa = null; // {id, libres}

/* ===== Plano: cargar coords + mesas ===== */
async function loadCoords(){
  const r = await fetch("./assets/mesas-coords.json?ts="+Date.now());
  COORDS = await r.json();
}

async function loadMesas(){
  const { data, error } = await sb.from("mesas").select("id,nombre,aforo,reservados").order("id");
  if(error){ console.error(error); return; }
  MESAS = data || [];
}

/* ===== Render overlay ===== */
function renderOverlay(){
  overlay.innerHTML = "";
  const wrap = document.getElementById("map-wrap");

  COORDS.forEach(c=>{
    const info = MESAS.find(x=>x.id===c.id) || {aforo:10,reservados:0,nombre:""};
    const libres = Math.max(0, (info.aforo||10) - (info.reservados||0));

    // Estado visual por colores (igual que antes)
    let cls = "m-ok";
    if(libres===0) cls = "m-err";
    else if(libres<=2) cls = "m-warn";

    const div = document.createElement("div");
    div.className = `mesa ${cls}`;
    div.style.left   = (c.left)+"%";
    div.style.top    = (c.top)+"%";
    div.style.width  = (c.width)+"%";
    div.style.height = (c.height)+"%";
    div.dataset.id = c.id;
    div.title = `Mesa ${c.id} â€“ libres: ${libres}`;
    div.innerHTML = `<span class="n">${c.id}</span>`;

    if(selectedMesa && selectedMesa.id===c.id) div.classList.add("selected");

    /* ðŸ”’ NUEVO: bloquear cualquier mesa parcialmente ocupada.
       Solo se puede reservar cuando la mesa estÃ¡ totalmente libre (reservados == 0).
       Las mesas llenas ya estaban bloqueadas. */
    if (info.reservados > 0 || libres === 0) {
      div.style.pointerEvents = "none";
      div.title = (libres===0) ? `Mesa ${c.id} â€“ llena` : `Mesa ${c.id} â€“ ya reservada (parcial)`;
    } else {
      // Solo si estÃ¡ completamente libre permitimos seleccionar
      div.addEventListener("click", ()=> selectMesa(c.id, libres));
    }

    overlay.appendChild(div);
  });
}

/* ===== Lista desplegable de estado ===== */
function renderStateList(){
  stateList.innerHTML = "";
  MESAS.forEach(m=>{
    const libres = Math.max(0, (m.aforo||10) - (m.reservados||0));
    let cls="ok", txt="Disponible";
    if(libres===0){ cls="err"; txt="LLENA"; }
    else if(libres<=2){ cls="warn"; txt="Pocos cupos"; }
    const li = document.createElement("div");
    li.className = "state-item";
    li.innerHTML = `
      <span class="dot ${cls}"></span>
      <span>Mesa ${m.id} â€“ ${m.nombre||"SalÃ³n"}</span>
      <span class="tag ${cls}" style="margin-left:auto">${txt} (${libres})</span>
    `;
    stateList.appendChild(li);
  });
}

/* ===== Seleccionar mesa ===== */
function selectMesa(id, libres){
  selectedMesa = { id, libres };
  mesaInput.value = String(id);
  mesaHint.textContent = (libres>0) ? `Mesa ${id} seleccionada. Cupos libres: ${libres}` : "Mesa sin cupo";
  renderOverlay();
  form.scrollIntoView({behavior:"smooth", block:"start"});
  validateAll();
}

/* ===== Bloques dinÃ¡micos (socios/invitados) ===== */
function renderBloques(){
  const total = Number(cantidadSel.value||0);
  const asiste = (respAsiste.value==="si");
  let s = Math.min(10, Math.max(0, Number(inptSoc.value||0)));
  let i = Math.min(10, Math.max(0, Number(inptInv.value||0)));
  if(asiste){
    if(s===0) s=1;
    inptSoc.value = s;
  }
  const suma = s+i;
  lblSuma.textContent = `Seleccionados ${suma} de ${total} cupos`;
  lblSuma.style.color = (suma===total? '#a4a6ad' : '#ff5a5a');

  boxSoc.innerHTML = "";
  if(s>0){
    const title=document.createElement("h3"); title.textContent=`Datos de Socios (${s})`; title.style.margin='0 0 6px 0'; boxSoc.appendChild(title);
    for(let x=1;x<=s;x++){
      const wrap=document.createElement('div'); wrap.className='grid grid-2';
      const pre = (x===1 && respAsiste.value==="si") ? " â€“ Responsable" : "";
      wrap.innerHTML = `
        <div><label>Socio ${x}${pre} â€“ Nombre</label><input id="socio_nombre_${x}" required /></div>
        <div><label>Socio ${x}${pre} â€“ Apellido</label><input id="socio_apellido_${x}" required /></div>
        <div><label>Socio ${x}${pre} â€“ Celular/WhatsApp</label><input id="socio_cel_${x}" inputmode="tel" required /></div>
        <div><label>Socio ${x}${pre} â€“ N.Âº de acciÃ³n/cupo</label><input id="socio_accion_${x}" required /></div>
      `;
      boxSoc.appendChild(wrap);
    }
    if(respAsiste.value==="si"){
      $("socio_nombre_1").value = ($("nombres").value||"").split(" ")[0]||"";
      $("socio_apellido_1").value = ($("nombres").value||"").split(" ").slice(1).join(" ");
      $("socio_cel_1").value = $("contacto").value||"";
    }
  }

  boxInv.innerHTML = "";
  if(i>0){
    const title=document.createElement("h3"); title.textContent=`Datos de Invitados (${i})`; title.style.margin='0 0 6px 0'; boxInv.appendChild(title);
    for(let x=1;x<=i;x++){
      const wrap=document.createElement('div'); wrap.className='grid grid-2';
      wrap.innerHTML = `
        <div><label>Invitado ${x} â€“ Tipo de documento</label>
          <select id="inv_tipo_${x}" required><option value="">Seleccionaâ€¦</option><option>CC</option><option>TI</option><option>CE</option><option>PAS</option><option>Otro</option></select>
        </div>
        <div><label>Invitado ${x} â€“ NÃºmero de documento</label><input id="inv_doc_${x}" required /></div>
        <div><label>Invitado ${x} â€“ Primer Nombre</label><input id="inv_pnom_${x}" required /></div>
        <div><label>Invitado ${x} â€“ Segundo Nombre</label><input id="inv_snom_${x}" /></div>
        <div><label>Invitado ${x} â€“ Primer Apellido</label><input id="inv_pape_${x}" required /></div>
        <div><label>Invitado ${x} â€“ Segundo Apellido</label><input id="inv_sape_${x}" /></div>
        <div><label>Invitado ${x} â€“ Correo electrÃ³nico</label><input id="inv_cor_${x}" type="email" required /></div>
        <div><label>Invitado ${x} â€“ NÃºmero de celular</label><input id="inv_cel_${x}" inputmode="tel" required /></div>
      `;
      boxInv.appendChild(wrap);
    }
  }
  actualizarPago();
  validateAll();
}

/* ===== Pago invitados ===== */
function actualizarPago(){
  const invitados = Math.min(10, Math.max(0, Number(inptInv.value||0)));
  const total = invitados * 250000;
  const fmt = (n)=> n.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
  document.getElementById('resumen-pago').innerHTML = `${invitados} invitado${invitados===1?'':'s'} Ã— $250.000 = <strong>${fmt(total)}</strong>`;
  return total;
}

/* ===== Validaciones globales ===== */
function validateAll(){
  const cantidad = Number(cantidadSel.value||0);
  const s = Math.min(10, Math.max(0, Number(inptSoc.value||0)));
  const i = Math.min(10, Math.max(0, Number(inptInv.value||0)));
  const sumaOK = (s+i) === cantidad && cantidad>=8 && cantidad<=10;
  const mesaOK = !!mesaInput.value;
  const checkOK = $("acepto").checked;
  btnEnviar.disabled = !(sumaOK && mesaOK && checkOK);
}

/* ===== EnvÃ­o ===== */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(btnEnviar.disabled) return;
  btnEnviar.disabled = true; estado.textContent='Procesandoâ€¦'; estado.className='hint';
  try{
    const cantidad = Number(cantidadSel.value||0);
    const socios=[], invitados=[];
    for(let x=1;x<=Number(inptSoc.value||0);x++){
      socios.push({
        nombre: $("socio_nombre_"+x)?.value||"",
        apellido: $("socio_apellido_"+x)?.value||"",
        celular: $("socio_cel_"+x)?.value||"",
        accion: $("socio_accion_"+x)?.value||""
      });
    }
    for(let x=1;x<=Number(inptInv.value||0);x++){
      invitados.push({
        tipo: $("inv_tipo_"+x)?.value||"",
        documento: $("inv_doc_"+x)?.value||"",
        pnombre: $("inv_pnom_"+x)?.value||"",
        snombre: $("inv_snom_"+x)?.value||null,
        papellido: $("inv_pape_"+x)?.value||"",
        sapellido: $("inv_sape_"+x)?.value||null,
        correo: $("inv_cor_"+x)?.value||"",
        celular: $("inv_cel_"+x)?.value||""
      });
    }
    const grupo = { socios, invitados, total:cantidad, resp_asiste: (respAsiste.value==="si") };

    const { data, error } = await sb.rpc('reserve_seats_v2',{
      p_mesa_id: Number(mesaInput.value),
      p_cantidad: cantidad,
      p_responsable: $("nombres").value,
      p_contacto: $("contacto").value,
      p_correo: $("correo").value,
      p_pago_url: null,
      p_invitado: grupo,
      p_evento: null
    });

    if(error){
      if((error.message||'').includes('SIN_CUPO')){
        estado.textContent='La mesa no tiene cupo suficiente (alguien la tomÃ³ antes).'; estado.className='danger';
        await reloadAll(); btnEnviar.disabled=false; return;
      }
      throw error;
    }

    // âœ… Mensaje de Ã©xito sin ID y recarga limpia
    estado.textContent = 'RESERVADO CON Ã‰XITO';
    estado.className = 'ok';

    setTimeout(()=>{ window.location.reload(); }, 1200);

  }catch(err){
    console.error(err);
    estado.textContent='OcurriÃ³ un error al reservar. Intenta de nuevo.'; estado.className='danger';
  }finally{
    btnEnviar.disabled=false;
  }
});

/* ===== Eventos UI ===== */
["change","input"].forEach(evt=>{
  [cantidadSel,inptSoc,inptInv,respAsiste].forEach(el=> el.addEventListener(evt, renderBloques));
  ["nombres","contacto"].forEach(id=> $(id).addEventListener(evt, renderBloques));
  $("acepto").addEventListener(evt, validateAll);
});

/* ===== Botones + / - para mÃ³viles ===== */
function bindQtyButtons(){
  document.querySelectorAll('.qty-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id    = btn.dataset.target;
      const delta = Number(btn.dataset.delta);
      const el    = document.getElementById(id);
      const min   = Number(el.min || 0);
      const max   = Number(el.max || 10);

      let val = Number(el.value || 0) + delta;

      // Si el responsable asiste, al menos 1 socio
      if(id === 'cupos_socios' && respAsiste.value === 'si'){
        if(val < 1) val = 1;
      }

      val = Math.max(min, Math.min(max, val));
      el.value = String(val);

      renderBloques();
    }, {passive:true});
  });
}
respAsiste.addEventListener('change', bindQtyButtons);
bindQtyButtons();

/* ===== Auto refresh ===== */
async function reloadAll(){
  await loadMesas();
  renderOverlay();
  renderStateList();
}
setInterval(reloadAll, 15000);

/* ===== Inicio ===== */
(async()=>{
  await loadCoords();
  await reloadAll();
  renderBloques();
})();
</script>
</body>
</html>
