<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – Fiesta Blanco & Negro</title>
  <style>
    :root{--bg:#0b0b0d;--card:#141418;--muted:#a4a6ad;--text:#f1f1f3;--ok:#1aa34a;--warn:#f6c445;--err:#ff5a5a}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    h1{margin:0 0 14px}
    .card{background:#141418;border:1px solid #22242a;border-radius:16px;padding:16px;margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #272a31;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,select,button{background:#0f1013;border:1px solid #2c2f36;border-radius:10px;color:var(--text);padding:8px 10px}
    button{cursor:pointer} button:hover{background:#151826}
    .btn{padding:10px 14px;border-radius:10px}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .danger{color:var(--err)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .kpis .k{background:#0f1013;border:1px dashed #2c2f36;border-radius:12px;padding:12px;text-align:center}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .b-ok{background:#0d2; color:#000} .b-warn{background:#fb0;color:#000} .b-err{background:#f55;color:#fff}
    .login{max-width:420px;margin:18vh auto 0;background:#141418;border:1px solid #22242a;border-radius:16px;padding:18px}
    .login h2{margin:0 0 8px}
  </style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- LOGIN -->
  <div id="login" class="login" style="display:none">
    <h2>Acceso al panel</h2>
    <p class="muted">Ingresa la contraseña de administrador.</p>
    <div class="row">
      <input id="pwd" type="password" placeholder="Contraseña" style="flex:1"/>
      <button id="btn-enter" class="btn">Entrar</button>
    </div>
    <p id="login-msg" class="danger" style="display:none;margin-top:8px">Contraseña incorrecta</p>
  </div>

  <!-- APP -->
  <div id="app" class="wrap" style="display:none">
    <h1>Panel admin</h1>

    <div class="card row" style="justify-content:space-between">
      <div class="row">
        <button class="btn" id="btn-refresh">Refrescar</button>
        <button class="btn" id="btn-export">Exportar CSV</button>
      </div>
      <div class="row">
        <span class="muted">Filtros:</span>
        <label class="muted">Estado</label>
        <select id="f-estado">
          <option value="">Todos</option>
          <option value="pendiente">pendiente</option>
          <option value="confirmado">confirmado</option>
          <option value="cancelado">cancelado</option>
        </select>
        <label class="muted">Mesa</label>
        <input id="f-mesa" placeholder="ID mesa" style="width:110px"/>
      </div>
    </div>

    <!-- KPIs -->
    <div class="card">
      <div class="kpis">
        <div class="k"><div class="muted">Mesas</div><div id="k-mesas" style="font-size:24px;font-weight:700">–</div></div>
        <div class="k"><div class="muted">Reservados</div><div id="k-res" style="font-size:24px;font-weight:700">–</div></div>
        <div class="k"><div class="muted">Disponibles</div><div id="k-disp" style="font-size:24px;font-weight:700">–</div></div>
        <div class="k"><div class="muted">% Ocupación</div><div id="k-occ" style="font-size:24px;font-weight:700">–</div></div>
      </div>
    </div>

    <!-- MESAS -->
    <div class="card">
      <h3 style="margin:0 0 10px">Ocupación por mesa (edición de <code>reservados</code>)</h3>
      <table id="tbl-mesas">
        <thead><tr><th>Mesa</th><th>Nombre</th><th>Aforo</th><th>Reservados</th><th>Cupos</th><th>Editar</th></tr></thead>
        <tbody></tbody>
      </table>
      <p class="muted">Consejo: para bloquear cupos puedes subir <code>reservados</code> o bajar <code>aforo</code> desde el Dashboard de Supabase.</p>
    </div>

    <!-- RESERVAS -->
    <div class="card">
      <h3 style="margin:0 0 10px">Reservas</h3>
      <table id="tbl-reservas">
        <thead>
          <tr>
            <th>Fecha</th><th>ID</th><th>Mesa</th><th>Resp.</th><th>Correo</th><th>Teléfono</th><th>Cantidad</th><th>Estado</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="muted" id="count"></p>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://cmrydhzpcuklfvigboka.supabase.co";   // <-- reemplazar
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtcnlkaHpwY3VrbGZ2aWdib2thIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzU1NDIsImV4cCI6MjA3ODExMTU0Mn0.SzLh-CoahU63AISJwPKJLJkAf-JQ2qxAwUt69NsPKgQ";                  // <-- reemplazar
    const ADMIN_PASSWORD = "Campestre2025$**";               // <-- cámbiala antes de publicar

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== Login simple (cliente) ======
    const loginView = document.getElementById('login');
    const appView   = document.getElementById('app');
    const pwdInput  = document.getElementById('pwd');
    const btnEnter  = document.getElementById('btn-enter');
    const loginMsg  = document.getElementById('login-msg');

    function showApp(){ loginView.style.display='none'; appView.style.display='block'; }
    function showLogin(){ loginView.style.display='block'; appView.style.display='none'; }

    function checkSession(){
      const ok = localStorage.getItem('admin_ok') === '1';
      ok ? showApp() : showLogin();
      return ok;
    }
    btnEnter.addEventListener('click', ()=>{
      if(pwdInput.value === ADMIN_PASSWORD){
        localStorage.setItem('admin_ok','1');
        showApp(); init();
      } else {
        loginMsg.style.display='block';
      }
    });
    // Enter key
    pwdInput.addEventListener('keydown', e=>{ if(e.key==='Enter') btnEnter.click(); });

    // ====== UI refs ======
    const $ = (q)=>document.querySelector(q);
    const kMesas = $("#k-mesas"), kRes = $("#k-res"), kDisp = $("#k-disp"), kOcc = $("#k-occ");
    const tblMesas = $("#tbl-mesas tbody");
    const tblRes = $("#tbl-reservas tbody");
    const fEstado = $("#f-estado"), fMesa = $("#f-mesa");
    const btnRefresh = $("#btn-refresh"), btnExport = $("#btn-export");
    const countEl = $("#count");

    let cacheMesas = [], cacheReservas = [];

    // ====== Helpers ======
    function fmtCOP(n){ return Number(n||0).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}); }
    function occBadge(cupos){
      if(cupos <= 0) return '<span class="badge b-err">LLENA</span>';
      if(cupos <= 3) return '<span class="badge b-warn">'+cupos+' disp.</span>';
      return '<span class="badge b-ok">'+cupos+' disp.</span>';
    }
    function download(filename, text){
      const a = document.createElement('a');
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      URL.revokeObjectURL(a.href);
    }

    // ====== Data ======
    async function cargarMesas(){
      const { data, error } = await sb.from('mesas').select('id,nombre,aforo,reservados').order('id',{ascending:true});
      if(error){ tblMesas.innerHTML = '<tr><td colspan="6">Error: '+error.message+'</td></tr>'; return; }
      cacheMesas = data;
      renderMesas();
      renderKpis();
    }

    function renderKpis(){
      const totalMesas = cacheMesas.length;
      const totalAforo = cacheMesas.reduce((a,m)=>a+(m.aforo||0),0);
      const totalRes   = cacheMesas.reduce((a,m)=>a+(m.reservados||0),0);
      const disp       = Math.max(0, totalAforo - totalRes);
      const occ        = totalAforo>0 ? Math.round((totalRes/totalAforo)*100) : 0;
      kMesas.textContent = totalMesas;
      kRes.textContent   = totalRes;
      kDisp.textContent  = disp;
      kOcc.textContent   = occ+'%';
    }

    function renderMesas(){
      tblMesas.innerHTML = '';
      for(const m of cacheMesas){
        const cupos = Math.max(0,(m.aforo||0)-(m.reservados||0));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.id}</td>
          <td>${m.nombre||''}</td>
          <td>${m.aforo}</td>
          <td>${m.reservados}</td>
          <td>${cupos} ${occBadge(cupos)}</td>
          <td>
            <div class="row">
              <input type="number" min="0" value="${m.reservados}" style="width:110px" id="edit-res-${m.id}" />
              <button class="btn" data-save="${m.id}">Actualizar</button>
            </div>
          </td>`;
        tblMesas.appendChild(tr);
      }
     tblMesas.querySelectorAll('[data-save]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const id = Number(btn.dataset.save);
    const val = Number(document.getElementById('edit-res-'+id).value);
    const code = prompt('Clave de edición (la misma del admin):');
    if(!code) return;
    btn.disabled = true; btn.textContent = 'Guardando…';
    const { error } = await sb.rpc('admin_update_reservados', {
      p_code: code,
      p_mesa_id: id,
      p_reservados: val
    });
    btn.disabled = false; btn.textContent = 'Actualizar';
    if(error){ alert('Error: '+error.message); return; }
    await cargarMesas();
  });
});

    }

    async function cargarReservas(){
      let query = sb.from('reservas').select('id,mesa_id,responsable,correo,contacto,cantidad,estado,created_at,evento').order('created_at',{ascending:false}).limit(500);
      if(fEstado.value) query = query.eq('estado', fEstado.value);
      if(fMesa.value.trim()) query = query.eq('mesa_id', Number(fMesa.value.trim()));
      const { data, error } = await query;
      if(error){ tblRes.innerHTML = '<tr><td colspan="8">Error: '+error.message+'</td></tr>'; return; }
      cacheReservas = data;
      renderReservas();
    }

    function renderReservas(){
      tblRes.innerHTML = '';
      for(const r of cacheReservas){
        const fecha = new Date(r.created_at).toLocaleString();
        const mesaNom = (r.evento && r.evento.mesa && r.evento.mesa.nombre) ? ` – ${r.evento.mesa.nombre}` : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fecha}</td><td>${r.id}</td><td>${r.mesa_id}${mesaNom}</td>
          <td>${r.responsable}</td><td>${r.correo}</td><td>${r.contacto}</td>
          <td>${r.cantidad}</td><td>${r.estado}</td>`;
        tblRes.appendChild(tr);
      }
      countEl.textContent = `Mostrando ${cacheReservas.length} reservas.`;
    }

    // ====== Export CSV ======
    function exportCSV(){
      const rows = [
        ['fecha','id','mesa','mesa_nombre','responsable','correo','telefono','cantidad','estado']
      ];
      for(const r of cacheReservas){
        const fecha = new Date(r.created_at).toISOString();
        const mesaNombre = (r.evento && r.evento.mesa && r.evento.mesa.nombre) ? r.evento.mesa.nombre : '';
        rows.push([fecha, r.id, r.mesa_id, mesaNombre, r.responsable, r.correo, r.contacto, r.cantidad, r.estado]);
      }
      const csv = rows.map(r=>r.map(x=>{
        const s = (x??'').toString().replaceAll('"','""');
        return `"${s}"`;
      }).join(',')).join('\n');
      download('reservas.csv', csv);
    }

    // ====== Events ======
    btnRefresh.addEventListener('click', ()=>{ cargarMesas(); cargarReservas(); });
    fEstado.addEventListener('change', cargarReservas);
    fMesa.addEventListener('input', cargarReservas);
    btnExport.addEventListener('click', exportCSV);

    // ====== Init ======
    async function init(){ await cargarMesas(); await cargarReservas(); }
    if(checkSession()){ init(); }
  </script>
</body>
</html>
